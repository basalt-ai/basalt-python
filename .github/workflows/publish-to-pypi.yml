name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'  # Déclenche sur les tags qui commencent par 'v' (ex: v1.1.1, v2.0.0)

  # Permet l'exécution manuelle depuis l'onglet Actions
  workflow_dispatch:

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
      with:
        enable-cache: true

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install hatch
      run: uv tool install hatch

    - name: Install dependencies
      run: |
        uv pip install --system --editable .
        uv pip install --system pytest pytest-cov anyio pytest-asyncio

    - name: Run tests
      run: hatch run test

  publish:
    name: Build and publish to PyPI
    needs: test  # Attend que tous les tests passent
    runs-on: ubuntu-latest

    # Permissions nécessaires pour créer des releases GitHub
    permissions:
      contents: write
      id-token: write  # Nécessaire pour PyPI trusted publishing (optionnel)

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
      with:
        enable-cache: true

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: '3.12'

    - name: Install hatch
      run: uv tool install hatch

    - name: Extract version from tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Verify version matches
      run: |
        PACKAGE_VERSION=$(hatch version)
        TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
        echo "Package version: $PACKAGE_VERSION"
        echo "Tag version: $TAG_VERSION"
        if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
          echo "❌ Error: Package version ($PACKAGE_VERSION) does not match tag version ($TAG_VERSION)"
          exit 1
        fi
        echo "✅ Version check passed"

    - name: Build package
      run: hatch build

    - name: Publish to PyPI
      env:
        HATCH_INDEX_USER: __token__
        HATCH_INDEX_AUTH: ${{ secrets.PYPI_API_TOKEN }}
      run: hatch publish

    - name: Create GitHub Release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        tag_name: ${{ steps.get_version.outputs.TAG }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Installation
          ```bash
          pip install basalt-sdk==${{ steps.get_version.outputs.VERSION }}
          ```

          ## What's Changed
          See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.

          ## PyPI
          https://pypi.org/project/basalt-sdk/${{ steps.get_version.outputs.VERSION }}/
        draft: false
        prerelease: false
